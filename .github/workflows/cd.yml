name: CD - Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.detect.outputs.has_changes }}
      changed_services: ${{ steps.detect.outputs.changed_services }}
      frontend_changed: ${{ steps.detect.outputs.frontend_changed }}
      api_server_changed: ${{ steps.detect.outputs.api_server_changed }}
      ticket_server_changed: ${{ steps.detect.outputs.ticket_server_changed }}
      queue_backend_changed: ${{ steps.detect.outputs.queue_backend_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: detect
        run: |
          chmod +x .github/scripts/detect-changes.sh
          # Compare with previous commit on main
          .github/scripts/detect-changes.sh HEAD~1

  # Frontend Deploy
  deploy-frontend:
    name: Deploy - Frontend
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # SSH 키 설정
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

          # 배포 서버에서 빌드 및 배포
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'EOF'
            cd /app/web10-beastcamp

            # 최신 코드 가져오기
            git fetch origin main
            git reset --hard origin/main

            # frontend 서비스 재배포
            docker-compose build frontend
            docker-compose up -d frontend

            # 이전 이미지 정리
            docker image prune -f

            echo "✅ Frontend deployed successfully"
          EOF

  # API Server Deploy
  deploy-api-server:
    name: Deploy - API Server
    needs: detect-changes
    if: needs.detect-changes.outputs.api_server_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # SSH 키 설정
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

          # 배포 서버에서 빌드 및 배포
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'EOF'
            cd /app/web10-beastcamp

            # 최신 코드 가져오기
            git fetch origin main
            git reset --hard origin/main

            # api-server 서비스 재배포
            docker-compose build api-server
            docker-compose up -d api-server

            # 이전 이미지 정리
            docker image prune -f

            echo "✅ API Server deployed successfully"
          EOF

  # Ticket Server Deploy
  deploy-ticket-server:
    name: Deploy - Ticket Server
    needs: detect-changes
    if: needs.detect-changes.outputs.ticket_server_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # SSH 키 설정
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

          # 배포 서버에서 빌드 및 배포
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'EOF'
            cd /app/web10-beastcamp

            # 최신 코드 가져오기
            git fetch origin main
            git reset --hard origin/main

            # ticket-server 서비스 재배포
            docker-compose build ticket-server
            docker-compose up -d ticket-server

            # 이전 이미지 정리
            docker image prune -f

            echo "✅ Ticket Server deployed successfully"
          EOF

  # Queue Backend Deploy
  deploy-queue-backend:
    name: Deploy - Queue Backend
    needs: detect-changes
    if: needs.detect-changes.outputs.queue_backend_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # SSH 키 설정
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

          # 배포 서버에서 빌드 및 배포
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'EOF'
            cd /app/web10-beastcamp

            # 최신 코드 가져오기
            git fetch origin main
            git reset --hard origin/main

            # queue-backend 서비스 재배포
            docker-compose build queue-backend
            docker-compose up -d queue-backend

            # 이전 이미지 정리
            docker image prune -f

            echo "✅ Queue Backend deployed successfully"
          EOF

  # Deployment Summary
  deployment-summary:
    name: Deployment Summary
    needs: [detect-changes, deploy-frontend, deploy-api-server, deploy-ticket-server, deploy-queue-backend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Deployment Results
        run: |
          echo "=== Deployment Summary ==="
          echo "Changed services: ${{ needs.detect-changes.outputs.changed_services }}"

          if [ "${{ needs.detect-changes.outputs.has_changes }}" == "false" ]; then
            echo "No services changed - skipping deployment"
            exit 0
          fi

          echo ""
          echo "Deployment Results:"
          echo "- Frontend: ${{ needs.deploy-frontend.result }}"
          echo "- API Server: ${{ needs.deploy-api-server.result }}"
          echo "- Ticket Server: ${{ needs.deploy-ticket-server.result }}"
          echo "- Queue Backend: ${{ needs.deploy-queue-backend.result }}"

          # Check if any deployment failed
          if [ "${{ contains(needs.*.result, 'failure') }}" == "true" ]; then
            echo ""
            echo "❌ Some deployments failed"
            exit 1
          fi

          echo ""
          echo "✅ All deployments completed successfully"
