name: CD - Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.detect.outputs.has_changes }}
      changed_services: ${{ steps.detect.outputs.changed_services }}
      frontend_changed: ${{ steps.detect.outputs.frontend_changed }}
      api_server_changed: ${{ steps.detect.outputs.api_server_changed }}
      ticket_server_changed: ${{ steps.detect.outputs.ticket_server_changed }}
      queue_backend_changed: ${{ steps.detect.outputs.queue_backend_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: detect
        run: |
          chmod +x .github/scripts/detect-changes.sh
          # Compare with previous commit on main
          .github/scripts/detect-changes.sh HEAD~1

  # Frontend Deploy
  deploy-frontend:
    name: Deploy - Frontend
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to frontend server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.FRONTEND_SSH_KEY }}
          SERVER_HOST: ${{ secrets.FRONTEND_SERVER_HOST }}
          SERVER_USER: ${{ secrets.FRONTEND_SERVER_USER }}
        run: |
          # SSH 키 설정
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

          # 프론트엔드 서버에서 빌드 및 배포
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'EOF'
            cd /app/web10-beastcamp

            # 최신 코드 가져오기
            git fetch origin main
            git reset --hard origin/main

            # frontend 서비스 재배포
            cd frontend
            docker-compose build
            docker-compose up -d

            # 이전 이미지 정리
            docker image prune -f

            echo "✅ Frontend deployed successfully"
          EOF

  # Backend Servers Deploy (api-server + ticket-server)
  deploy-backend:
    name: Deploy - Backend Servers
    needs: detect-changes
    if: needs.detect-changes.outputs.api_server_changed == 'true' || needs.detect-changes.outputs.ticket_server_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to backend server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.BACKEND_SSH_KEY }}
          SERVER_HOST: ${{ secrets.BACKEND_SERVER_HOST }}
          SERVER_USER: ${{ secrets.BACKEND_SERVER_USER }}
          API_SERVER_CHANGED: ${{ needs.detect-changes.outputs.api_server_changed }}
          TICKET_SERVER_CHANGED: ${{ needs.detect-changes.outputs.ticket_server_changed }}
        run: |
          # SSH 키 설정
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

          # 백엔드 서버에서 빌드 및 배포
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << EOF
            cd /app/web10-beastcamp

            # 최신 코드 가져오기
            git fetch origin main
            git reset --hard origin/main

            cd backend

            # 변경된 서비스만 재배포
            if [ "$API_SERVER_CHANGED" == "true" ]; then
              echo "🚀 Deploying api-server..."
              docker-compose build api-server
              docker-compose up -d api-server
              echo "✅ API Server deployed successfully"
            fi

            if [ "$TICKET_SERVER_CHANGED" == "true" ]; then
              echo "🚀 Deploying ticket-server..."
              docker-compose build ticket-server
              docker-compose up -d ticket-server
              echo "✅ Ticket Server deployed successfully"
            fi

            # 이전 이미지 정리
            docker image prune -f
          EOF

  # Queue Backend Deploy
  deploy-queue-backend:
    name: Deploy - Queue Backend
    needs: detect-changes
    if: needs.detect-changes.outputs.queue_backend_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to queue server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.QUEUE_SSH_KEY }}
          SERVER_HOST: ${{ secrets.QUEUE_SERVER_HOST }}
          SERVER_USER: ${{ secrets.QUEUE_SERVER_USER }}
        run: |
          # SSH 키 설정
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

          # 큐 서버에서 빌드 및 배포
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST << 'EOF'
            cd /app/web10-beastcamp

            # 최신 코드 가져오기
            git fetch origin main
            git reset --hard origin/main

            # queue-backend 서비스 재배포
            cd queue-backend
            docker-compose build
            docker-compose up -d

            # 이전 이미지 정리
            docker image prune -f

            echo "✅ Queue Backend deployed successfully"
          EOF

  # Deployment Summary
  deployment-summary:
    name: Deployment Summary
    needs: [detect-changes, deploy-frontend, deploy-backend, deploy-queue-backend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Deployment Results
        run: |
          echo "=== Deployment Summary ==="
          echo "Changed services: ${{ needs.detect-changes.outputs.changed_services }}"

          if [ "${{ needs.detect-changes.outputs.has_changes }}" == "false" ]; then
            echo "No services changed - skipping deployment"
            exit 0
          fi

          echo ""
          echo "Deployment Results:"
          echo "- Frontend: ${{ needs.deploy-frontend.result }}"
          echo "- Backend (API + Ticket): ${{ needs.deploy-backend.result }}"
          echo "- Queue Backend: ${{ needs.deploy-queue-backend.result }}"

          # Check if any deployment failed
          if [ "${{ contains(needs.*.result, 'failure') }}" == "true" ]; then
            echo ""
            echo "❌ Some deployments failed"
            exit 1
          fi

          echo ""
          echo "✅ All deployments completed successfully"
