name: CD - Manual Deploy

on:
  workflow_dispatch:
    inputs:
      services:
        description: "ë°°í¬ ëŒ€ìƒ ì„ íƒ"
        required: true
        default: "backend"
        type: choice
        options:
          - backend
          - api-server
          - ticket-server
          - queue-backend
          - all
      branch:
        description: "ë°°í¬í•  ë¸Œëœì¹˜ (ì˜ˆ: dev)"
        required: true
        default: "dev"

jobs:
  resolve-targets:
    name: ë°°í¬ ëŒ€ìƒ ê²°ì •
    runs-on: ubuntu-latest
    outputs:
      has_targets: ${{ steps.targets.outputs.has_targets }}
      changed_services: ${{ steps.targets.outputs.changed_services }}
      api_server: ${{ steps.targets.outputs.api_server }}
      ticket_server: ${{ steps.targets.outputs.ticket_server }}
      queue_backend: ${{ steps.targets.outputs.queue_backend }}
    steps:
      - name: ì„œë¹„ìŠ¤ ì…ë ¥ íŒŒì‹±
        id: targets
        shell: bash
        run: |
          SERVICES_RAW="${{ github.event.inputs.services }}"
          SERVICES=$(echo "$SERVICES_RAW" | tr '[:upper:]' '[:lower:]' | tr -d ' ')

          API=false
          TICKET=false
          QUEUE=false

          case "$SERVICES" in
            all)
              API=true
              TICKET=true
              QUEUE=true
              ;;
            backend)
              API=true; TICKET=true
              ;;
            api-server)
              API=true
              ;;
            ticket-server)
              TICKET=true
              ;;
            queue-backend)
              QUEUE=true
              ;;
          esac

          HAS=false
          if [ "$API" = "true" ] || [ "$TICKET" = "true" ] || [ "$QUEUE" = "true" ]; then
            HAS=true
          fi

          CHANGED=""
          if [ "$API" = "true" ]; then CHANGED="${CHANGED} api-server"; fi
          if [ "$TICKET" = "true" ]; then CHANGED="${CHANGED} ticket-server"; fi
          if [ "$QUEUE" = "true" ]; then CHANGED="${CHANGED} queue-backend"; fi

          echo "has_targets=$HAS" >> "$GITHUB_OUTPUT"
          echo "changed_services=${CHANGED# }" >> "$GITHUB_OUTPUT"
          echo "api_server=$API" >> "$GITHUB_OUTPUT"
          echo "ticket_server=$TICKET" >> "$GITHUB_OUTPUT"
          echo "queue_backend=$QUEUE" >> "$GITHUB_OUTPUT"

          if [ "$HAS" != "true" ]; then
            echo "ìœ íš¨í•œ ì„œë¹„ìŠ¤ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤: $SERVICES_RAW"
            exit 1
          fi

  build-and-push:
    name: ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    needs: resolve-targets
    if: needs.resolve-targets.outputs.has_targets == 'true'
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: ì´ë¯¸ì§€ íƒœê·¸ ì„¤ì •
        id: meta
        shell: bash
        run: |
          IMAGE_TAG=$(git rev-parse HEAD)
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"

      - name: NCP ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        env:
          NCP_REGISTRY_URL: ${{ secrets.NCP_REGISTRY_URL }}
          NCP_REGISTRY_USERNAME: ${{ secrets.NCP_REGISTRY_USERNAME }}
          NCP_REGISTRY_PASSWORD: ${{ secrets.NCP_REGISTRY_PASSWORD }}
        run: |
          echo "$NCP_REGISTRY_PASSWORD" | docker login "$NCP_REGISTRY_URL" -u "$NCP_REGISTRY_USERNAME" --password-stdin

      - name: ì„ íƒëœ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        env:
          NCP_REGISTRY_URL: ${{ secrets.NCP_REGISTRY_URL }}
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
          API_SERVER: ${{ needs.resolve-targets.outputs.api_server }}
          TICKET_SERVER: ${{ needs.resolve-targets.outputs.ticket_server }}
          QUEUE_BACKEND: ${{ needs.resolve-targets.outputs.queue_backend }}
        run: |
          if [ "$API_SERVER" = "true" ]; then
            docker build -f backend/api-server/Dockerfile -t "$NCP_REGISTRY_URL/beastcamp-api-server:$IMAGE_TAG" .
            docker push "$NCP_REGISTRY_URL/beastcamp-api-server:$IMAGE_TAG"
          fi

          if [ "$TICKET_SERVER" = "true" ]; then
            docker build -f backend/ticket-server/Dockerfile -t "$NCP_REGISTRY_URL/beastcamp-ticket-server:$IMAGE_TAG" .
            docker push "$NCP_REGISTRY_URL/beastcamp-ticket-server:$IMAGE_TAG"
          fi

          if [ "$QUEUE_BACKEND" = "true" ]; then
            docker build -f queue-backend/Dockerfile -t "$NCP_REGISTRY_URL/beastcamp-queue-backend:$IMAGE_TAG" .
            docker push "$NCP_REGISTRY_URL/beastcamp-queue-backend:$IMAGE_TAG"
          fi

  deploy-backend:
    name: Deploy - Backend Servers
    needs: [resolve-targets, build-and-push]
    if: needs.resolve-targets.outputs.api_server == 'true' || needs.resolve-targets.outputs.ticket_server == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to backend server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.BACKEND_SERVER_HOST }}
          username: ${{ secrets.BACKEND_SERVER_USER }}
          password: ${{ secrets.BACKEND_SERVER_PASSWORD }}
          envs: NCP_REGISTRY_URL,NCP_REGISTRY_USERNAME,NCP_REGISTRY_PASSWORD,API_SERVER_CHANGED,TICKET_SERVER_CHANGED,TARGET_BRANCH,IMAGE_TAG,LOKI_URL
          script: |
            cd /app/web10-beastcamp

            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git fetch origin $TARGET_BRANCH
            git reset --hard origin/$TARGET_BRANCH

            cd backend

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (LOKI_URL ì£¼ì…)
            if [ ! -f .env ]; then touch .env; fi
            sed -i '/^LOKI_URL=/d' .env
            echo "LOKI_URL=$LOKI_URL" >> .env

            # ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ì¬ë°°í¬
            if [ "$API_SERVER_CHANGED" == "true" ]; then
              echo "ğŸš€ Deploying api-server..."
              echo "$NCP_REGISTRY_PASSWORD" | docker login "$NCP_REGISTRY_URL" -u "$NCP_REGISTRY_USERNAME" --password-stdin
              printf "services:\n  api-server:\n    image: %s\n" "$NCP_REGISTRY_URL/beastcamp-api-server:$IMAGE_TAG" > /tmp/backend.override.yml
              docker compose -f docker-compose.yml -f /tmp/backend.override.yml pull api-server promtail
              docker compose -f docker-compose.yml -f /tmp/backend.override.yml up -d --no-build api-server promtail
              echo "âœ… API Server deployed successfully"
            fi

            if [ "$TICKET_SERVER_CHANGED" == "true" ]; then
              echo "ğŸš€ Deploying ticket-server..."
              echo "$NCP_REGISTRY_PASSWORD" | docker login "$NCP_REGISTRY_URL" -u "$NCP_REGISTRY_USERNAME" --password-stdin
              printf "services:\n  ticket-server:\n    image: %s\n" "$NCP_REGISTRY_URL/beastcamp-ticket-server:$IMAGE_TAG" > /tmp/backend.override.yml
              docker compose -f docker-compose.yml -f /tmp/backend.override.yml pull ticket-server promtail
              docker compose -f docker-compose.yml -f /tmp/backend.override.yml up -d --no-build ticket-server promtail
              echo "âœ… Ticket Server deployed successfully"
            fi

            # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
        env:
          NCP_REGISTRY_URL: ${{ secrets.NCP_REGISTRY_URL }}
          NCP_REGISTRY_USERNAME: ${{ secrets.NCP_REGISTRY_USERNAME }}
          NCP_REGISTRY_PASSWORD: ${{ secrets.NCP_REGISTRY_PASSWORD }}
          API_SERVER_CHANGED: ${{ needs.resolve-targets.outputs.api_server }}
          TICKET_SERVER_CHANGED: ${{ needs.resolve-targets.outputs.ticket_server }}
          TARGET_BRANCH: ${{ github.event.inputs.branch }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
          LOKI_URL: ${{ secrets.LOKI_URL }}

  deploy-queue-backend:
    name: Deploy - Queue Backend
    needs: [resolve-targets, build-and-push]
    if: needs.resolve-targets.outputs.queue_backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to queue server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.QUEUE_SERVER_HOST }}
          username: ${{ secrets.QUEUE_SERVER_USER }}
          password: ${{ secrets.QUEUE_SERVER_PASSWORD }}
          envs: NCP_REGISTRY_URL,NCP_REGISTRY_USERNAME,NCP_REGISTRY_PASSWORD,TARGET_BRANCH,IMAGE_TAG,LOKI_URL
          script: |
            cd /app/web10-beastcamp

            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git fetch origin $TARGET_BRANCH
            git reset --hard origin/$TARGET_BRANCH

            # queue-backend ì„œë¹„ìŠ¤ ì¬ë°°í¬
            cd queue-backend

            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (LOKI_URL ì£¼ì…)
            if [ ! -f .env ]; then touch .env; fi
            sed -i '/^LOKI_URL=/d' .env
            echo "LOKI_URL=$LOKI_URL" >> .env

            echo "$NCP_REGISTRY_PASSWORD" | docker login "$NCP_REGISTRY_URL" -u "$NCP_REGISTRY_USERNAME" --password-stdin
            printf "services:\n  queue-backend:\n    image: %s\n" "$NCP_REGISTRY_URL/beastcamp-queue-backend:$IMAGE_TAG" > /tmp/queue.override.yml
            docker compose -f docker-compose.yml -f /tmp/queue.override.yml pull queue-backend promtail
            docker compose -f docker-compose.yml -f /tmp/queue.override.yml up -d --no-build queue-backend promtail

            # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f

            echo "âœ… Queue Backend deployed successfully"
        env:
          NCP_REGISTRY_URL: ${{ secrets.NCP_REGISTRY_URL }}
          NCP_REGISTRY_USERNAME: ${{ secrets.NCP_REGISTRY_USERNAME }}
          NCP_REGISTRY_PASSWORD: ${{ secrets.NCP_REGISTRY_PASSWORD }}
          TARGET_BRANCH: ${{ github.event.inputs.branch }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
          LOKI_URL: ${{ secrets.LOKI_URL }}

  deployment-summary:
    name: Deployment Summary
    needs:
      [resolve-targets, build-and-push, deploy-backend, deploy-queue-backend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Deployment Results
        run: |
          echo "=== ë°°í¬ ìš”ì•½ ==="
          echo "ëŒ€ìƒ: ${{ needs.resolve-targets.outputs.changed_services }}"
          echo ""
          echo "Deployment Results:"
          echo "- Backend (API + Ticket): ${{ needs.deploy-backend.result }}"
          echo "- Queue Backend: ${{ needs.deploy-queue-backend.result }}"

          if [ "${{ contains(needs.*.result, 'failure') }}" == "true" ]; then
            echo ""
            echo "âŒ ì¼ë¶€ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
            exit 1
          fi

          echo ""
          echo "âœ… ìˆ˜ë™ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"
