name: CD - Manual Deploy (Optimized)

on:
  workflow_dispatch:
    inputs:
      services:
        description: "ë°°í¬ ëŒ€ìƒ ì„ íƒ"
        required: true
        default: "backend"
        type: choice
        options:
          - backend
          - api-server
          - ticket-server
          - queue-backend
          - all
      branch:
        description: "ë°°í¬í•  ë¸Œëœì¹˜"
        required: true
        default: "dev"

jobs:
  # 1ë‹¨ê³„: ë°°í¬ ëŒ€ìƒ ê²°ì • (JSON ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±)
  resolve-targets:
    name: ë°°í¬ ëŒ€ìƒ ê²°ì •
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_targets: ${{ steps.set-matrix.outputs.has_targets }}
    steps:
      - id: set-matrix
        shell: bash
        run: |
          SERVICES="${{ github.event.inputs.services }}"
          if [ "$SERVICES" = "all" ]; then
            JSON='["api-server", "ticket-server", "queue-backend"]'
          elif [ "$SERVICES" = "backend" ]; then
            JSON='["api-server", "ticket-server"]'
          else
            JSON="[\"$SERVICES\"]"
          fi
          echo "matrix=$JSON" >> "$GITHUB_OUTPUT"
          echo "has_targets=true" >> "$GITHUB_OUTPUT"

  # 2ë‹¨ê³„: ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (GHA ìºì‹œ í™œìš©)
  build-and-push:
    name: Build & Push - ${{ matrix.service }}
    needs: resolve-targets
    if: needs.resolve-targets.outputs.has_targets == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.resolve-targets.outputs.matrix) }}
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Docker Buildx ì„¤ì¹˜
        uses: docker/setup-buildx-action@v3

      - name: NCP ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.NCP_REGISTRY_URL }}
          username: ${{ secrets.NCP_REGISTRY_USERNAME }}
          password: ${{ secrets.NCP_REGISTRY_PASSWORD }}

      - name: ${{ matrix.service }} ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service == 'queue-backend' && 'queue-backend/Dockerfile' || format('backend/{0}/Dockerfile', matrix.service) }}
          push: true
          tags: ${{ secrets.NCP_REGISTRY_URL }}/beastcamp-${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 3ë‹¨ê³„: ê° ì„œë²„ë¡œ ë°°í¬ (ì¸ì¦ ì •ë³´ ë™ì  ë§¤í•‘)
  deploy:
    name: Deploy - ${{ matrix.service }}
    needs: [resolve-targets, build-and-push]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: api-server
            host_secret: BACKEND_SERVER_HOST
            user_secret: BACKEND_SERVER_USER
            pass_secret: BACKEND_SERVER_PASSWORD
          - service: ticket-server
            host_secret: BACKEND_SERVER_HOST
            user_secret: BACKEND_SERVER_USER
            pass_secret: BACKEND_SERVER_PASSWORD
          - service: queue-backend
            host_secret: QUEUE_SERVER_HOST
            user_secret: QUEUE_SERVER_USER
            pass_secret: QUEUE_SERVER_PASSWORD
    steps:
      - name: ë°°í¬ ì‹¤í–‰
        if: contains(fromJson(needs.resolve-targets.outputs.matrix), matrix.service)
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Matrixì— ì •ì˜ëœ í‚¤ ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ ì„œë²„ë³„ë¡œ ë‹¤ë¥¸ ë¹„ë°€ë²ˆí˜¸/í˜¸ìŠ¤íŠ¸ ì£¼ì…
          host: ${{ secrets[matrix.host_secret] }}
          username: ${{ secrets[matrix.user_secret] }}
          password: ${{ secrets[matrix.pass_secret] }}
          envs: NCP_REGISTRY_URL,NCP_REGISTRY_USERNAME,NCP_REGISTRY_PASSWORD,IMAGE_TAG,SERVICE_NAME,TARGET_BRANCH,LOKI_URL
          script: |
            cd /app/web10-beastcamp

            # 1. ìµœì‹  ì½”ë“œ ë™ê¸°í™”
            git fetch origin $TARGET_BRANCH
            git reset --hard origin/$TARGET_BRANCH

            # 2. ì„œë¹„ìŠ¤ ìœ„ì¹˜ë¡œ ì´ë™
            [ "$SERVICE_NAME" == "queue-backend" ] && cd queue-backend || cd backend

            # 3. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (LOKI_URL ì£¼ì…)
            if [ ! -f .env ]; then touch .env; fi
            sed -i '/^LOKI_URL=/d' .env
            echo "LOKI_URL=$LOKI_URL" >> .env

            # 4. NCP ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
            echo "$NCP_REGISTRY_PASSWORD" | docker login "$NCP_REGISTRY_URL" -u "$NCP_REGISTRY_USERNAME" --password-stdin

            # 5. ë°°í¬ (Clean Export ë¬¸ë²• ë°˜ì˜ ë° --wait ì ìš©)
            export IMAGE_TAG NCP_REGISTRY_URL SERVICE_NAME LOKI_URL

            echo "ğŸš€ $SERVICE_NAME ë°°í¬ ì¤‘ (Healthcheck ëŒ€ê¸°)..."
            docker compose pull $SERVICE_NAME promtail
            docker compose up -d --wait --no-build $SERVICE_NAME promtail

            # 5. ë””ìŠ¤í¬ ì²­ì†Œ (24ì‹œê°„ ì´ë‚´ ì´ë¯¸ì§€ëŠ” ë³´ì¡´í•˜ì—¬ ë¡¤ë°± ëŒ€ë¹„)
            docker image prune -af --filter "until=24h"
            echo "âœ… $SERVICE_NAME ë°°í¬ ì™„ë£Œ"
        env:
          IMAGE_TAG: ${{ github.sha }}
          SERVICE_NAME: ${{ matrix.service }}
          TARGET_BRANCH: ${{ github.event.inputs.branch }}
          NCP_REGISTRY_URL: ${{ secrets.NCP_REGISTRY_URL }}
          NCP_REGISTRY_USERNAME: ${{ secrets.NCP_REGISTRY_USERNAME }}
          NCP_REGISTRY_PASSWORD: ${{ secrets.NCP_REGISTRY_PASSWORD }}
          LOKI_URL: ${{ secrets.LOKI_URL }}

  # 4ë‹¨ê³„: ê²°ê³¼ ìš”ì•½
  deployment-summary:
    name: Deployment Summary
    needs: [resolve-targets, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ê²°ê³¼ ì¶œë ¥
        run: |
          echo "=== ë°°í¬ ìš”ì•½ ==="
          echo "ëŒ€ìƒ: ${{ needs.resolve-targets.outputs.matrix }}"
          echo "ê²°ê³¼: ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
