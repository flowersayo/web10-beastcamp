name: CD - Manual Deploy (Optimized)

on:
  workflow_dispatch:
    inputs:
      services:
        description: "배포 대상 선택"
        required: true
        default: "backend"
        type: choice
        options:
          - backend
          - api-server
          - ticket-server
          - queue-backend
          - all
      branch:
        description: "배포할 브랜치"
        required: true
        default: "dev"

jobs:
  # 1단계: 어떤 서비스를 빌드/배포할지 결정하는 작업
  resolve-targets:
    name: 배포 대상 결정
    runs-on: ubuntu-latest
    outputs:
      # 빌드와 배포에서 사용할 리스트를 JSON 형태로 내보냄
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_targets: ${{ steps.set-matrix.outputs.has_targets }}
    steps:
      - id: set-matrix
        shell: bash
        run: |
          SERVICES="${{ github.event.inputs.services }}"
          # 입력값에 따라 매트릭스 구성 (JSON 배열)
          if [ "$SERVICES" = "all" ]; then
            JSON='["api-server", "ticket-server", "queue-backend"]'
          elif [ "$SERVICES" = "backend" ]; then
            JSON='["api-server", "ticket-server"]'
          else
            JSON="[\"$SERVICES\"]"
          fi
          
          echo "matrix=$JSON" >> "$GITHUB_OUTPUT"
          echo "has_targets=true" >> "$GITHUB_OUTPUT"

  # 2단계: 이미지 빌드 및 푸시 (동시 병렬 처리)
  build-and-push:
    name: Build & Push - ${{ matrix.service }}
    needs: resolve-targets
    if: needs.resolve-targets.outputs.has_targets == 'true'
    runs-on: ubuntu-latest
    strategy:
      # 결정된 서비스 개수만큼 머신을 동시에 띄워서 빌드
      matrix:
        service: ${{ fromJson(needs.resolve-targets.outputs.matrix) }}
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Docker Buildx 설치 (캐싱 활성화용)
        uses: docker/setup-buildx-action@v3

      - name: NCP 레지스트리 로그인
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.NCP_REGISTRY_URL }}
          username: ${{ secrets.NCP_REGISTRY_USERNAME }}
          password: ${{ secrets.NCP_REGISTRY_PASSWORD }}

      - name: ${{ matrix.service }} 빌드 및 푸시
        uses: docker/build-push-action@v5
        with:
          context: .
          # Dockerfile 경로 동적 설정
          file: ${{ matrix.service == 'queue-backend' && 'queue-backend/Dockerfile' || format('backend/{0}/Dockerfile', matrix.service) }}
          push: true
          # 이미지 태그를 커밋 해시로 고정 (버전 관리 용이)
          tags: ${{ secrets.NCP_REGISTRY_URL }}/beastcamp-${{ matrix.service }}:${{ github.sha }}
          # GHA 전용 캐시 사용 (pnpm fetch 레이어 등을 영구 보존)
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 3단계: 각 서버로 배포 (병렬 실행)
  deploy:
    name: Deploy - ${{ matrix.service }}
    needs: [resolve-targets, build-and-push]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: api-server
            host_secret: BACKEND_SERVER_HOST
          - service: ticket-server
            host_secret: BACKEND_SERVER_HOST
          - service: queue-backend
            host_secret: QUEUE_SERVER_HOST
    steps:
      # Job if에서 matrix를 못 쓰기 때문에 Step if에서 필터링
      - name: 배포 타겟 확인 및 실행
        if: contains(fromJson(needs.resolve-targets.outputs.matrix), matrix.service)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets[matrix.host_secret] }}
          username: ${{ secrets.BACKEND_SERVER_USER }}
          password: ${{ secrets.BACKEND_SERVER_PASSWORD }}
          # 서버로 넘길 환경변수들
          envs: NCP_REGISTRY_URL,NCP_REGISTRY_USERNAME,NCP_REGISTRY_PASSWORD,IMAGE_TAG,SERVICE_NAME,TARGET_BRANCH
          script: |
            cd /app/web10-beastcamp
            
            # 1. 최신 코드로 동기화 (설정파일 업데이트용)
            git fetch origin $TARGET_BRANCH
            git reset --hard origin/$TARGET_BRANCH
            
            # 2. 서비스 위치로 이동
            [ "$SERVICE_NAME" == "queue-backend" ] && cd queue-backend || cd backend
            
            # 3. NCP 레지스트리 로그인
            echo "$NCP_REGISTRY_PASSWORD" | docker login "$NCP_REGISTRY_URL" -u "$NCP_REGISTRY_USERNAME" --password-stdin
            
            # 4. 배포 (Override 파일 생성 없이 환경변수로 이미지 주입)
            # 서버의 docker-compose.yml에 image: ...:${IMAGE_TAG} 설정이 되어있어야 함
            export IMAGE_TAG=$IMAGE_TAG
            docker compose pull $SERVICE_NAME
            docker compose up -d --no-build $SERVICE_NAME
            
            # 5. 디스크 청소
            docker image prune -f
            echo "✅ $SERVICE_NAME 배포 완료"
        env:
          NCP_REGISTRY_URL: ${{ secrets.NCP_REGISTRY_URL }}
          NCP_REGISTRY_USERNAME: ${{ secrets.NCP_REGISTRY_USERNAME }}
          NCP_REGISTRY_PASSWORD: ${{ secrets.NCP_REGISTRY_PASSWORD }}
          IMAGE_TAG: ${{ github.sha }}
          SERVICE_NAME: ${{ matrix.service }}
          TARGET_BRANCH: ${{ github.event.inputs.branch }}

  # 4단계: 결과 요약
  deployment-summary:
    name: Deployment Summary
    needs: [resolve-targets, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: 결과 출력
        run: |
          echo "=== 배포가 완료되었습니다 ==="
          echo "대상: ${{ needs.resolve-targets.outputs.matrix }}"
