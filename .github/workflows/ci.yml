name: CI - Pull Request

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]

jobs:
  detect-changes:
    name: ğŸ” Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.detect.outputs.has_changes }}
      backend_matrix: ${{ steps.filter.outputs.matrix }}
      frontend_changed: ${{ steps.detect.outputs.frontend_changed }}
      changed_services: ${{ steps.detect.outputs.changed_services }}
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ•µï¸ Run Change Detection Script
        id: detect
        run: |
          chmod +x .github/scripts/detect-changes.sh
          BASE="${{ github.base_ref || github.ref_name }}"
          .github/scripts/detect-changes.sh "origin/$BASE"

      - name: ğŸ§ª Filter Backend Matrix
        id: filter
        run: |
          # ê°ì§€ëœ ì „ì²´ ì„œë¹„ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          SERVICES='${{ steps.detect.outputs.changed_services }}'

          # ë°±ì—”ë“œë§Œ ì†ì•„ë‚´ê¸° (sed)
          BACKEND=$(echo $SERVICES | sed 's/"frontend",//g; s/,"frontend"//g; s/\["frontend"\]/[]/g')

          echo "matrix=$BACKEND" >> $GITHUB_OUTPUT

      - name: ğŸ“¢ Detection Result Summary
        run: |
          echo "### ğŸ” Detection Result" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Changes:** ${{ steps.detect.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Changed:** ${{ steps.detect.outputs.frontend_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Matrix:** \`${{ steps.filter.outputs.matrix }}\`" >> $GITHUB_STEP_SUMMARY

  # Frontend CI
  ci-frontend:
    name: ğŸ¨ CI - Frontend
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with: { version: 10.28.1 }

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with: { node-version: "22", cache: "pnpm" }

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Shared Packages
        run: pnpm --filter "./packages/*" build

      - name: ğŸ§¹ Run Lint
        run: pnpm --filter frontend lint

      - name: ğŸ—ï¸ Build Application (Next.js)
        run: pnpm --filter frontend build
        # Next.js ë¹Œë“œ ì‹œ í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        # env:
        #   NEXT_PUBLIC_API_URL: ${{ secrets.API_URL }}

      - name: ğŸ³ Docker Build Check
        uses: docker/build-push-action@v5
        with:
          context: .
          file: frontend/Dockerfile
          push: false # CIëŠ” ê²€ì‚¬ë§Œ í•˜ë¯€ë¡œ í‘¸ì‹œëŠ” í•˜ì§€ ì•ŠìŒ!
          cache-from: type=gha
          cache-to: type=gha,mode=max

  ci-backend:
    name: âš™ï¸ CI - Backend
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && needs.detect-changes.outputs.backend_matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.backend_matrix) }}
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with: { version: 10.28.1 }

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with: { node-version: "22", cache: "pnpm" }

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Shared Packages
        run: pnpm --filter "./packages/*" build

      - name: ğŸ§¹ Run Lint
        run: pnpm --filter @beastcamp/${{ matrix.service }} lint

      - name: ğŸ§ª Run Unit Tests
        run: pnpm --filter @beastcamp/${{ matrix.service }} test

      - name: ğŸ³ Docker Build Check
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service == 'queue-backend' && 'queue-backend/Dockerfile' || format('backend/{0}/Dockerfile', matrix.service) }}
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  ci-summary:
    name: ğŸ“Š CI Result Summary
    needs: [detect-changes, ci-frontend, ci-backend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ Final Status Check
        run: |
          F_ST="${{ needs.ci-frontend.result }}"
          B_ST="${{ needs.ci-backend.result }}"
          if [[ "$F_ST" == "failure" || "$B_ST" == "failure" ]]; then
            echo "âŒ CI Failed: Please check your code"
            exit 1
          fi
          echo "âœ… CI Passed: Deployment ready"
