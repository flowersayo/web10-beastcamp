name: CI - Pull Request

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.detect.outputs.has_changes }}
      changed_services: ${{ steps.detect.outputs.changed_services }}
      frontend_changed: ${{ steps.detect.outputs.frontend_changed }}
      api_server_changed: ${{ steps.detect.outputs.api_server_changed }}
      ticket_server_changed: ${{ steps.detect.outputs.ticket_server_changed }}
      queue_backend_changed: ${{ steps.detect.outputs.queue_backend_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: detect
        run: |
          chmod +x .github/scripts/detect-changes.sh
          .github/scripts/detect-changes.sh origin/main

  # Frontend CI
  ci-frontend:
    name: CI - Frontend
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm --filter frontend lint

      - name: Build
        run: pnpm --filter frontend build

  # API Server CI
  ci-api-server:
    name: CI - API Server
    needs: detect-changes
    if: needs.detect-changes.outputs.api_server_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm --filter @beastcamp/api-server lint

      - name: Test
        run: pnpm --filter @beastcamp/api-server test

      - name: Build
        run: pnpm --filter @beastcamp/api-server build

  # Ticket Server CI
  ci-ticket-server:
    name: CI - Ticket Server
    needs: detect-changes
    if: needs.detect-changes.outputs.ticket_server_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm --filter @beastcamp/ticket-server lint

      - name: Test
        run: pnpm --filter @beastcamp/ticket-server test

      - name: Build
        run: pnpm --filter @beastcamp/ticket-server build

  # Queue Backend CI
  ci-queue-backend:
    name: CI - Queue Backend
    needs: detect-changes
    if: needs.detect-changes.outputs.queue_backend_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm --filter @beastcamp/queue-backend lint

      - name: Test
        run: pnpm --filter @beastcamp/queue-backend test

      - name: Build
        run: pnpm --filter @beastcamp/queue-backend build

  # CI Summary
  ci-summary:
    name: CI Summary
    needs: [detect-changes, ci-frontend, ci-api-server, ci-ticket-server, ci-queue-backend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check CI Results
        run: |
          echo "Changed services: ${{ needs.detect-changes.outputs.changed_services }}"
          if [ "${{ needs.detect-changes.outputs.has_changes }}" == "false" ]; then
            echo "No services changed - skipping CI"
            exit 0
          fi

          # Check if any CI job failed
          if [ "${{ contains(needs.*.result, 'failure') }}" == "true" ]; then
            echo "Some CI jobs failed"
            exit 1
          fi

          echo "All CI jobs passed"
