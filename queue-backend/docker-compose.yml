version: '3.8'

services:
  redis:
    image: redis:7.2-alpine
    container_name: queue-redis
    ports:
      - '6379:6379'
    networks:
      - queue-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5
    # volumes:
    #   - ./queue-backend/redis_data:/data
  queue-backend:
    image: ${NCP_REGISTRY_URL}/beastcamp-queue-backend:${IMAGE_TAG:-latest}
    container_name: queue-backend
    ports:
      - '3003:3003'
    environment:
      - NODE_ENV=production
    env_file:
      - .env
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - queue-network
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  promtail:
    image: grafana/promtail:2.9.0
    container_name: promtail-queue
    user: root
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./promtail-config.yaml:/etc/promtail/config.yaml
    command: -config.file=/etc/promtail/config.yaml -config.expand-env=true
    environment:
      - LOKI_URL=${LOKI_URL:-http://host.docker.internal:3100/loki/api/v1/push}
    networks:
      - queue-network
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

networks:
  queue-network:
    driver: bridge
